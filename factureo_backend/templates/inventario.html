{% extends 'base.html' %}
{% block title %}Inventario - Factureo{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Inventario</h3>
    <form class="d-flex gap-2" method="get" action="{{ url_for('inventario.list_products') }}">
        <input type="text" class="form-control" name="q" value="{{ request.args.get('q','') }}" placeholder="Buscar por nombre, código o descripción">
        <input type="text" class="form-control" name="categoria" value="{{ request.args.get('categoria','') }}" placeholder="Categoría">
        <button class="btn btn-outline-light" type="submit"><i class="bi bi-search"></i> Buscar</button>
    </form>
    </div>
<div class="d-flex justify-content-end mb-2">
    <div class="btn-group" role="group" aria-label="Cambiar vista">
        <button class="btn btn-outline-light btn-sm" id="btnVistaTarjetas"
            onclick="document.getElementById('vista-tarjetas').classList.remove('d-none');document.getElementById('vista-tabla').classList.add('d-none');">Tarjetas</button>
        <button class="btn btn-outline-light btn-sm" id="btnVistaTabla"
            onclick="document.getElementById('vista-tabla').classList.remove('d-none');document.getElementById('vista-tarjetas').classList.add('d-none');">Tabla</button>
    </div>
</div>
<form class="row g-2 mb-3" method="POST" action="{{ url_for('inventario.create_product') }}">
    <div class="col-md-3"><input class="form-control" name="nombre" placeholder="Nombre" title="Nombre del producto"
            required></div>
    <div class="col-md-1"><input type="text" class="form-control" name="codigo" placeholder="Código" title="Código"></div>
    <div class="col-md-2"><input type="number" class="form-control" name="cantidad" placeholder="Cantidad"
            title="Cantidad" min="0" required></div>
    <div class="col-md-2"><input type="number" step="0.01" class="form-control" name="costo" placeholder="Costo" title="Costo" min="0"></div>
    <div class="col-md-2"><input type="number" step="0.01" class="form-control" name="precio_venta" placeholder="Precio venta" title="Precio de venta" min="0" required></div>
    <div class="col-md-2"><input class="form-control" name="categoria" placeholder="Categoría" title="Categoría"></div>
    <div class="col-md-1"><input type="number" class="form-control" name="stock_min" placeholder="Min" title="Stock mínimo" min="0"></div>
    <div class="col-md-12 mt-2"><input class="form-control" name="descripcion" placeholder="Descripción" title="Descripción"></div>
    <div class="col-md-2 d-grid mt-2"><button type="submit" class="btn btn-success" title="Agregar producto"><i
                class="bi bi-plus-circle"></i> Agregar</button></div>
</form>

<div id="vista-tarjetas" class="row g-3 d-none">
    {% for p in productos %}
    <div class="col-sm-6 col-md-4 col-lg-3">
        <div class="card product-card h-100">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">{{ p.nombre }}</h5>
                    {% if p.categoria %}<span class="badge rounded-pill category">{{ p.categoria }}</span>{% endif %}
                </div>
                                <p class="card-text text-muted mb-2">Código: {{ p.codigo or '—' }}</p>
                                <p class="card-text mb-2">
                                    Cantidad: 
                                    {% if p.stock_min and p.cantidad|int <= p.stock_min|int %}
                                        <span class="badge bg-danger-subtle text-danger">{{ p.cantidad }}</span>
                                    {% else %}
                                        {{ p.cantidad }}
                                    {% endif %}
                                </p>
                                <p class="price h5 mt-auto mb-3">${{ '%.2f'|format((p.precio_venta or p.precio or 0)|float) }}</p>
                <div class="d-flex gap-2">
                    <form method="POST" action="{{ url_for('inventario.edit_product', id=p._id) }}" class="flex-grow-1">
                        <input type="hidden" name="nombre" value="{{ p.nombre }}">
                        <input type="hidden" name="cantidad" value="{{ p.cantidad }}">
                        <input type="hidden" name="precio" value="{{ p.precio }}">
                        <input type="hidden" name="categoria" value="{{ p.categoria }}">
                        <button type="submit" class="btn btn-primary btn-sm w-100" title="Guardar cambios" disabled>
                            <i class="bi bi-save"></i> Guardar
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('inventario.delete_product', id=p._id) }}">
                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar producto">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div id="vista-tabla">
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th>Categoría</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for p in productos %}
            <tr>
                <form method="POST" action="{{ url_for('inventario.edit_product', id=p._id) }}" class="row g-2">
            <td><input class="form-control" name="nombre" value="{{ p.nombre }}" placeholder="Nombre"
                            title="Nombre" required></td>
            <td><input class="form-control" name="codigo" value="{{ p.codigo }}" placeholder="Código" title="Código"></td>
                    <td><input type="number" class="form-control" name="cantidad" value="{{ p.cantidad }}"
                            placeholder="Cantidad" title="Cantidad" min="0" required></td>
            <td><input type="number" step="0.01" class="form-control" name="costo" value="{{ p.costo or '' }}" placeholder="Costo" title="Costo" min="0"></td>
            <td><input type="number" step="0.01" class="form-control" name="precio_venta" value="{{ p.precio_venta or p.precio }}"
                placeholder="Precio venta" title="Precio de venta" min="0" required></td>
            <td><input class="form-control" name="categoria" value="{{ p.categoria }}" placeholder="Categoría"
                            title="Categoría"></td>
            <td><input type="number" class="form-control" name="stock_min" value="{{ p.stock_min or '' }}" placeholder="Min" title="Stock mínimo" min="0"></td>
            <td><input class="form-control" name="descripcion" value="{{ p.descripcion or '' }}" placeholder="Descripción" title="Descripción"></td>
                    <td class="text-nowrap">
                        <button type="submit" class="btn btn-primary btn-sm" title="Guardar cambios"><i
                                class="bi bi-save"></i> Guardar</button>
                    </td>
                </form>
                <td class="text-nowrap">
                    <form method="POST" action="{{ url_for('inventario.delete_product', id=p._id) }}">
                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar producto"><i
                                class="bi bi-trash"></i> Eliminar</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}